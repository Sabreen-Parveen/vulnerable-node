name: 🛡️ Scan Docker image latest 🐳

on:
  push:
    branches:
      - master

jobs:
  scan:
    name: 🛡️ Scan image latest
    runs-on: ubuntu-latest
    steps:
      - uses: anchore/scan-action@v3
        id: scan
        with:
         image: optnc/domaine-nc-api:latest
         fail-build: true
         severity-cutoff: critical
      - name: Upload artifact
        uses: actions/upload-artifact@v1.0.0
        with:
          name: AnchoreReports
          path: ./anchore-reports/
      - name: Create/Update an issue of vulnerabilities 🛡️ that have been detected
        if: ${{ failure() }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          debug: true
          script: |
            const { owner, repo } = context.repo;
            const labels = ['security', 'docker-scan', 'Alert : Docker image scan'];

            const body = `Workflow failed for commit ${{github.sha}}.        

            Following vulnerabilities have been detected :
            \`\`\`
            ${{ steps.scan.outputs.report }}
            \`\`\`
                `;
            console.log(steps.scan.outputs);
            console.log(body);

            github.rest.issues.create({
              owner, repo,
              title : '🛡️ Docker image security scan failed 🛡️',
              body,
              labels
            });
