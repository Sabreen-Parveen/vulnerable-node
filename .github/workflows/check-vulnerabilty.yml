name: ğŸ›¡ï¸ Scan Docker image latest ğŸ³

on:
  push:
    branches:
      - master

jobs:
  scan:
    name: ğŸ›¡ï¸ Scan image latest
    runs-on: ubuntu-latest
    # outputs:
    #   # Map the step outputs to job outputs
    #   result: ${{steps.scan.outputs.result}}
    steps:
      - uses: anchore/scan-action@v3
        id: scan
        with:
         image: optnc/domaine-nc-api:latest
         fail-build: true
         severity-cutoff: critical

      - name: get the output
        if: ${{ failure() }}
        run: |
          # x=$(cat ${{ steps.scan.outputs.sarif }} | jq -r '.runs[0].tool.driver.rules[].shortDescription.text') 
          # x=$(echo $x | base64)
          export result=$(cat ${{ steps.scan.outputs.sarif }} | jq -r '.runs[0].tool.driver.rules[].shortDescription.text')
          delimiter="$(openssl rand -hex 8)"
          echo "result<<${delimiter}" >> ${GITHUB_ENV}
          echo "${result}" >> ${GITHUB_ENV}
          echo "${delimiter}" >> ${GITHUB_ENV}
          # echo "result=$(cat ${{ steps.scan.outputs.sarif }} | jq -r '.runs[0].tool.driver.rules[].shortDescription.text')" >> "$GITHUB_ENV"
          # echo result=$(cat ${{ steps.scan.outputs.sarif }} | jq -r '.runs[0].tool.driver.rules[].shortDescription.text') >> $GITHUB_OUTPUT
          # echo $result
 
      - name: Create/Update an issue of vulnerabilities ğŸ›¡ï¸ that have been detected
        if: ${{ failure() }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          debug: true
          script: |
            const { owner, repo } = context.repo;
            const labels = ['security', 'docker-scan', 'Alert : Docker image scan'];

            const body = `Workflow failed for commit ${{github.sha}}.        

            Following vulnerabilities have been detected :
            \`\`\`
            ${{ process.env.result }}
            \`\`\`
                `;
            console.log(process.env.result);
            console.log(body);

            github.rest.issues.create({
              owner, repo,
              title : 'ğŸ›¡ï¸ Docker image security scan failed ğŸ›¡ï¸',
              body,
              labels
            });
