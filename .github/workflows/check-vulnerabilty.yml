name: üõ°Ô∏è Scan Docker image latest üê≥

on:
  push:
    branches:
      - master

jobs:
  get_images:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.generate.outputs.myoutput }}
    steps:
      - name: checkout repo
        uses: actions/checkout@v3
      - name: Generate Image Matrix
        id: generate
        run: |
          images=($(cat docker-compose.yml | grep -i "image:" | awk '{print $2}'))
          image=$(jq -c -n '$ARGS.positional' --args "${images[@]}")
          echo $image
          # echo "dimages=$(echo $image | jq -R .)" >> $GITHUB_OUTPUT  
          echo "myoutput=$(jq -cn --argjson environments $image '{images: $environments}')" >> $GITHUB_OUTPUT          

  # my_echo:
  #   runs-on: ubuntu-latest
  #   needs:
  #     - get_images
  #   steps:
  #     - name: Echo previous outputs
  #       run: echo "${{ toJSON(needs.get_images.outputs.images) }}"

  scan:
    name: üõ°Ô∏è Scan image latest
    runs-on: ubuntu-latest
    needs: get_images
    # strategy:
    #   matrix: ${{ fromJSON(needs.get_images.outputs.images) }}
    steps:
      - uses: anchore/scan-action@v3
        id: scan
        with:
         image: grafana/promtail:2.2.0
         fail-build: true
         severity-cutoff: critical
         output-format: json

      # - name: get the output
      #   if: ${{ failure() }}
      #   run: |
      #     # x=$(cat ${{ steps.scan.outputs.json }} | jq  '.matches[].vulnerability.severity' | sort | uniq -c)
      #     # x=$(echo $x | base64)
      #     echo "Let us see the output"
      #     echo $(cat ${{ steps.scan.outputs.sarif }})
      #     export result=$(cat ${{ steps.scan.outputs.sarif }} | jq -r '.runs[0].tool.driver.rules[].shortDescription.text')
      #     delimiter="$(openssl rand -hex 8)"
      #     echo "result<<${delimiter}" >> ${GITHUB_ENV}
      #     echo "${result}" >> ${GITHUB_ENV}
      #     echo "${delimiter}" >> ${GITHUB_ENV}
      #     # echo "result=$(cat ${{ steps.scan.outputs.sarif }} | jq -r '.runs[0].tool.driver.rules[].shortDescription.text')" >> "$GITHUB_ENV"
      #     # echo result=$(cat ${{ steps.scan.outputs.sarif }} | jq -r '.runs[0].tool.driver.rules[].shortDescription.text') >> $GITHUB_OUTPUT
      #     # echo $result
     
      - name: Create/Update an issue of vulnerabilities üõ°Ô∏è that have been detected
        if: ${{ failure() }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          debug: true
          script: |
            const fs = require('fs');
          
            let data = fs.readFileSync(`${{ steps.scan.outputs.json }}`, 'utf8');
            console.log(data)
            data = data.matches;

            const { owner, repo } = context.repo;
            const labels = ['security', 'docker-scan', 'Alert : Docker image scan'];

            const vulnerabilities = data.map(item => item.vulnerability);

            // Extracting severities
            const severities = vulnerabilities.map(item => item.severity);

            // Counting the occurrences of each severity level
            const countBySeverity = severities.reduce((acc, severity) => {
              acc[severity] = (acc[severity] || 0) + 1;
              return acc;
            }, {});

            console.log("Count by Severity:", countBySeverity);

            let markdown = "| Image | Low | High | Medium | Critical | Scan Location |\n";
            markdown += "| --- | --- | --- | --- | --- | --- |\n";
            markdown += `| ${{ matrix.images }} |`;
            for (const severity of ["Low", "High", "Medium", "Critical"]) {
              markdown += ` ${countBySeverity[severity] || 0} |`;
            }
            markdown += " [CVE-2017-11671](https://security-tracker.debian.org/tracker/CVE-2017-11671) |\n";

            console.log(markdown);

            const body = `Workflow failed for commit ${{github.sha}}.
            Detected vulnerabilities in \`${{ matrix.images }}\` docker image.
            ${markdown}
                `;
            
            const issueBody = `Workflow failed for commit ${{github.sha}}.

            Following vulnerabilities have been detected :
                `;

            const response = await github.rest.issues.create({
              owner, repo,
              title : 'üõ°Ô∏è Docker image security scan failed üõ°Ô∏è',
              body,
              labels
            });

            console.log(response)
            github.rest.issues.createComment({
              issue_number: response.data.number,
              owner, repo,
              body: issueBody
            });


