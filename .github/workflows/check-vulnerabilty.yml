name: ğŸ›¡ï¸ Scan Docker image latest ğŸ³

on:
  push:
    branches:
      - master

jobs:
  scan:
    name: ğŸ›¡ï¸ Scan image latest
    runs-on: ubuntu-latest
    steps:
      - uses: anchore/scan-action@v3
        id: scan
        with:
          path: "."
      - name: Create/Update an issue of vulnerabilities ğŸ›¡ï¸ that have been detected
        if: ${{ failure() }}
        uses: actions/github-script@v6
        with:
          debug: true
          script: |
            const { owner, repo } = context.repo;
            const labels = ['security', 'docker-scan', 'Alert : Docker image scan'];

            // rÃ©cupÃ©ration de l'id de la derniÃ¨re issue (si existante)
            const existingIssue = (await github.paginate(github.rest.issues.listForRepo.endpoint.merge({
              owner, repo, state: 'open',labels
            }))).filter(i => i.title.indexOf('Docker image security scan') !== -1)[0];

            // crÃ©ation ou modification de l'issue
            const body = `Workflow failed for commit ${{github.sha}}.        

            Following vulnerabilities have been detected :
            \`\`\`
            ${{ steps.scan_report.outputs.report }}
            \`\`\`
                `;

            if (existingIssue) {
              github.rest.issues.update({ owner, repo, issue_number: existingIssue.number, body });
            } else {
              github.rest.issues.create({
                owner, repo,
                title : 'ğŸ›¡ï¸ Docker image security scan failed ğŸ›¡ï¸',
                body,
                labels
              });
            }
